# Weblib

## Description

Start a daemon process listening to a pipe. When started, the daemon flushes all rules in FILTER, blocks SSH port, and loads previously saved configuration in `/iptable.rules`.

The parent process sends a couple IP adresses to the daemon. When received, the daemon authorizes SSH connections for these specific IP addresses.

When the daemon is killed, it saves the current rules to file `/iptables.rules`, flushes everything, and blocks SSH port before dying.

## Usage

### Compile

```
$ cd src
$ make clean
rm -f main.o ip.o main.out
$ make
gcc -c  main.c
gcc -c  ip.c
gcc  -o main.out main.o ip.o
```

### Execute

Run `main.out`:

```
$ sudo ./main.out
Process_id of child process 23063 
New rule : sudo iptables -t filter --src 192.168.1.18 -I INPUT 1 -p TCP --dport 22 -j ACCEPT
Sending to daemon : 192.168.1.18
New rule : sudo iptables -t filter --src 192.168.1.20 -I INPUT 1 -p TCP --dport 22 -j ACCEPT
Sending to daemon : 192.168.1.20
Done!
```

Check the `iptables` rules

```
$ sudo iptables -L --line-numbers 
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     tcp  --  192.168.1.20         anywhere             tcp dpt:ssh
2    ACCEPT     tcp  --  192.168.1.18         anywhere             tcp dpt:ssh
3    DROP       tcp  --  anywhere             anywhere             tcp dpt:ssh
...

```

Kill the daemon

```
$ sudo kill 23063
```

Check the log file:

```
$ cat /Log.txt
Deamon started!
Block all IPs.
Load previous config from file iptables.rules...
Listening...
IP received = 192.168.1.18
New rule : sudo iptables -t filter --src 192.168.1.18 -I INPUT 1 -p TCP --dport 22 -j ACCEPT
Listening...
IP received = 192.168.1.20
New rule : sudo iptables -t filter --src 192.168.1.20 -I INPUT 1 -p TCP --dport 22 -j ACCEPT
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Listening...
Caught signal 15, killing daemon...
Saving rules to config file iptables.rules...
Locking all IPs before dying.
```

Check the `iptables` rules:

```
$ sudo iptables -L --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  anywhere             anywhere             tcp dpt:ssh
```

Check the saved config:

```
$ cat /iptables.rules 
# Generated by iptables-save v1.6.0 on Thu Sep  3 12:45:02 2020
*filter
:INPUT ACCEPT [197:33585]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [174:84406]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
-A INPUT -s 192.168.1.20/32 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -s 192.168.1.18/32 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j DROP
...
```

## Contact

PLease contact me at *nicolas.gensollen@gmail.com*

